#!/usr/bin/expect
proc tryInstallPackage { name } {
	global cmd oldresult result argv

	# Set result
	set result $name
	send_user "\nTrying to install missing package\n"
	# Encountering this result for the second time...
	if {$oldresult == $result} {
		send_user "$result has been tried twice with no results\n"
		send_user "Is this not an image? Aborting...\n"
		exit
	# Install the package with tlmgri
	} { close
		spawn tlmgri $result
		interact
		wait
		# Respawn pdflatex
		spawn $cmd {*}$argv
		exp_continue
	}
}

# Start latex and save the pid to kill it later
set cmd [lindex $argv 1]
set argv [lrange $argv 1 end]
spawn $cmd {*}$argv

# Initialize the saved result to compare later
set oldresult ""
set result ""

expect {
	# Regular sty file is missing
	-re "File .(.*). not found" {
		tryInstallPackage $expect_out(1,string)
	# Bibtex ldf file is missing
	} -re "language definition file (.*) was not foun" {
		tryInstallPackage $expect_out(1,string)
	# Font encoding file is missing
	} -re "Encoding file .(.*). not found" {
		tryInstallPackage $expect_out(1,string)
	# Glossaries language module (not working yet...)
	} -re "(glossaries-.*)' or similar" }
		tryInstallPackage $expect_out(1,string)
	# Timeout
	} timeout {
		send_user "Compilation timed out???"
		exit
	}
}
